<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Отчет по лабораторной работе №9</title>
    <style>
        body { font-family: Arial; margin: 40px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2, h3, h4 { color: #333; }
        h1 { border-bottom: 3px solid #3498db; padding-bottom: 10px; }
        h2 { border-bottom: 2px solid #3498db; padding-bottom: 8px; margin-top: 25px; }
        h3 { border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        pre { background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 5px; overflow-x: auto; margin: 10px 0; }
        code { font-family: 'Courier New', monospace; }
        ul { margin: 10px 0 10px 20px; }
        li { margin-bottom: 5px; }
        .note { background: #e8f4fc; border-left: 4px solid #3498db; padding: 10px; margin: 15px 0; }
        .warning { background: #fff8e1; border-left: 4px solid #ffc107; padding: 10px; margin: 15px 0; }
        .success { background: #e8f6f3; border-left: 4px solid #1abc9c; padding: 10px; margin: 15px 0; }
        .highlight { background: #fffacd; padding: 2px 4px; border-radius: 3px; }
        .sql-keyword { color: #f56565; }
        .sql-string { color: #f6ad55; }
        .sql-comment { color: #a0aec0; font-style: italic; }
        .sql-number { color: #63b3ed; }
    </style>
</head>
<body>
<div class="container">
    <h1>ОТЧЕТ ПО ЛАБОРАТОРНОЙ РАБОТЕ №9</h1>
    
    <h2>Цель работы</h2>
    <ul>
        <li>Реализовать CRUD (Create, Read, Update, Delete) для сущностей бизнес-логики приложения.</li>
        <li>Освоить работу с SQLite в памяти (:memory:) через модуль sqlite3.</li>
        <li>Понять принципы первичных и внешних ключей и их роль в связях между таблицами.</li>
        <li>Выделить контроллеры для работы с БД и для рендеринга страниц в отдельные модули.</li>
        <li>Использовать архитектуру MVC и соблюдать разделение ответственности.</li>
        <li>Отображать пользователям таблицу с валютами, на которые они подписаны.</li>
        <li>Реализовать полноценный роутер, который обрабатывает GET-запросы и выполняет сохранение/обновление данных и рендеринг страниц.</li>
        <li>Научиться тестировать функционал на примере сущностей currency и user с использованием unittest.mock.</li>
    </ul>
    
    <h2>2) Описание моделей, их свойств и связей</h2>
    
    <h3>2.1. Модель Author (models/author.py)</h3>
    <p>Представляет информацию об авторе проекта:</p>
    <ul>
        <li>name (str) — имя автора с валидацией минимальной длины</li>
        <li>group (str) — номер учебной группы с валидацией формата "PXXXX"</li>
        <li>Оба свойства доступны только для чтения (readonly properties)</li>
    </ul>
    
    <h3>2.2. Модель Currency (models/currency.py)</h3>
    <p>Представляет информацию о валюте:</p>
    <ul>
        <li>num_code (str) — цифровой код валюты</li>
        <li>char_code (str) — буквенный код валюты (3 символа) с валидацией</li>
        <li>name (str) — название валюты</li>
        <li>value (float) — курс к рублю с валидацией на положительность</li>
        <li>nominal (int) — номинал</li>
    </ul>
    
    <h3>2.3. Модель User (models/user.py)</h3>
    <p>Представляет пользователя системы:</p>
    <ul>
        <li>id (int) — уникальный идентификатор</li>
        <li>name (str) — имя пользователя с валидацией</li>
        <li>subscribed_currencies (list[str]) — список кодов подписанных валют</li>
        <li>Методы: subscribe_to_currency(), unsubscribe_from_currency()</li>
    </ul>
    
    <h3>2.4. Модель CurenciesList (models/currency_parser.py)</h3>
    <p>Для работы с внешним API курсов валют:</p>
    <ul>
        <li>id (str) — идентификатор валюты из API</li>
        <li>name_curr (str) — код валюты (3 символа)</li>
        <li>price (float) — текущий курс</li>
        <li>name (str) — полное название валюты</li>
        <li>previous (float) — предыдущее значение курса</li>
    </ul>
    
    <h3>2.5. Связи между моделями</h3>
    <ul>
        <li>Один User может иметь много подписок на Currency (many-to-many)</li>
        <li>Связь реализована через промежуточную таблицу user_currency в БД</li>
        <li>Author является отдельной сущностью без связей с другими моделями</li>
    </ul>
    
    <h2>3) Структура проекта</h2>
    <div class="note">
        <p>(файл находится в папке гугл диска)</p>
    </div>
    
    <h2>4) Реализация CRUD с примерами SQL-запросов</h2>
    
    <h3>4.1. Класс CurrencyRatesCRUD (databasecontroller.py)</h3>
    
    <h4>Create — Создание записей</h4>
<pre><code>def _create(self):
    __params = self.__currency_rates_obj.values
    
    named_params = []
    for currency_tuple in __params:
        named_params.append({
            'num_code': '000',
            'char_code': currency_tuple[0],
            'name': f'Валюта {currency_tuple[0]}',
            'value': float(currency_tuple[1]) if currency_tuple[1] else 0.0,
            'nominal': 1
        })
    
    __sqlquery = '''
        INSERT INTO currency (num_code, char_code, name, value, nominal) 
        VALUES (:num_code, :char_code, :name, :value, :nominal)
    '''
    self.__cursor.executemany(__sqlquery, named_params)
    self.__con.commit()</code></pre>
    
    <h4>Read - чтение записей</h4>
<pre><code>def _read(self, char_code: str = None):
    if char_code and len(char_code) == 3:
        # Параметризованный запрос для предотвращения SQL-инъекций
        sql = "SELECT * FROM currency WHERE char_code = ?"
        self.__cursor.execute(sql, (char_code,))
    else:
        # Получение всех записей
        self.__cursor.execute("SELECT * FROM currency")
    
    # Преобразование результатов в список словарей
    result_data = []
    for _row in self.__cursor.fetchall():
        _d = {
            'id': int(_row[0]),
            'num_code': _row[1],
            'char_code': _row[2],
            'name': _row[3],
            'value': float(_row[4]) if _row[4] else 0.0,
            'nominal': int(_row[5]) if _row[5] else 1
        }
        result_data.append(_d)
    
    return result_data</code></pre>
    
    <h4>Update - обновление записей</h4>
<pre><code>def _update(self, currency: dict['str': float]):
    currency_code = tuple(currency.keys())[0]
    currency_value = tuple(currency.values())[0]
    
    # SQL-запрос для обновления курса валюты
    upd_statement = f"UPDATE currency SET value = {currency_value} WHERE char_code = '{currency_code}'"
    self.__cursor.execute(upd_statement)
    self.__con.commit()</code></pre>
    
    <h4>Delete - удаление записей</h4>
<pre><code>def _delete(self, currency_id):
    # SQL-запрос для удаления валюты по ID
    del_statement = "DELETE FROM currency WHERE id = ?"
    self.__cursor.execute(del_statement, (currency_id,))
    self.__con.commit()</code></pre>
    
    <h3>4.2. Создание таблиц в БД</h3>
<pre><code>def __createtable(self):
    # Таблица пользователей
    self.__con.execute(
        "CREATE TABLE user ("
        "id INTEGER PRIMARY KEY AUTOINCREMENT, "
        "name TEXT NOT NULL);")
    
    # Таблица валют
    self.__con.execute("CREATE TABLE currency ("
        "id INTEGER PRIMARY KEY AUTOINCREMENT, "
        "num_code TEXT NOT NULL, "
        "char_code TEXT NOT NULL, "
        "name TEXT NOT NULL, "
        "value FLOAT, "
        "nominal INTEGER);")
    
    # Таблица связи пользователь-валюта (many-to-many)
    self.__con.execute("CREATE TABLE user_currency ("
        "id INTEGER PRIMARY KEY AUTOINCREMENT,"
        "user_id INTEGER NOT NULL,"
        "currency_id INTEGER NOT NULL,"
        "FOREIGN KEY(user_id) REFERENCES user(id),"
        "FOREIGN KEY(currency_id) REFERENCES currency(id));")
    
    self.__con.commit()</code></pre>
    
    <h2>5) Скриншоты работы приложения</h2>
    <div class="note">
        <p>(находятся в папке гугл диска)</p>
    </div>
    
    <h3>5.1. Главная страница (index.html)</h3>
    <ul>
        <li>Отображает список всех валют с текущими курсами</li>
        <li>Показывает статистику: количество отслеживаемых валют</li>
        <li>Содержит информацию об авторе проекта</li>
        <li>Предоставляет навигацию по основным разделам приложения</li>
    </ul>
    
    <h3>5.2. Страница валют (currencies.html)</h3>
    <ul>
        <li>Таблица с кодами, названиями, курсами и номиналами валют</li>
        <li>Кнопки для удаления валют с подтверждением</li>
        <li>Форма для ручного обновления курсов основных валют (USD, EUR, GBP, AUD)</li>
        <li>Ссылки для вывода данных в консоль и возврата на главную</li>
    </ul>
    
    <h3>5.3. Страница пользователей (users.html)</h3>
    <ul>
        <li>Таблица всех зарегистрированных пользователей</li>
        <li>Отображение аватаров (первая буква имени)</li>
        <li>Показывает количество подписок каждого пользователя</li>
        <li>Кнопка для добавления новых пользователей через модальное окно</li>
        <li>Ссылки для управления подписками каждого пользователя</li>
    </ul>
    
    <h3>5.4. Страница конкретного пользователя (user.html)</h3>
    <ul>
        <li>Профиль пользователя с ID и именем</li>
        <li>Список текущих подписок на валюты с возможностью отписки</li>
        <li>Форма для добавления новых подписок из списка доступных валют</li>
        <li>Быстрые действия для подписки на популярные валюты (USD, EUR)</li>
        <li>Визуальные уведомления об успешных операциях или ошибках</li>
    </ul>
    
    <h3>5.5. Страница автора (author.html)</h3>
    <ul>
        <li>Информация об авторе проекта (имя, группа)</li>
        <li>Описание использованных технологий (Python, SQLite, Jinja2, Bootstrap)</li>
        <li>Перечисление реализованного функционала</li>
        <li>Кнопка возврата на главную страницу</li>
    </ul>
    
    <h2>6.1. Модульные тесты моделей</h2>
    
    <h3>Тест модели Author (test_author.py):</h3>
<pre><code>def test_author_creation_with_default_group(self):
    """Тест создания автора с группой по умолчанию."""
    author = Author("Иван Иванов")
    self.assertEqual(author.name, "Иван Иванов")
    self.assertEqual(author.group, "P3122")</code></pre>
    
    <h3>Тест модели User (test_user.py):</h3>
<pre><code>def test_subscribe_to_currency_idempotent(self):
    """Тест идимпотентности добавления подписки."""
    user = User(id=5, name="Тест идимпотентности")
    user.subscribe_to_currency('USD')
    self.assertEqual(len(user.subscribed_currencies), 1)
    
    # Повторное добавление той же валюты
    user.subscribe_to_currency('USD')
    self.assertEqual(len(user.subscribed_currencies), 1)  # Длина не изменилась</code></pre>
    
    <h2>6.2. Тесты контроллеров</h2>
    
    <h3>Тест UserController (test_usercontroller.py):</h3>
<pre><code>def test_singleton_pattern(self):
    """Тест паттерна Singleton."""
    controller1 = UserController()
    controller2 = UserController()
    self.assertIs(controller1, controller2)  # Один и тот же объект</code></pre>
    
    <h2>6.3. Интеграционные тесты с unittest.mock (mocktest_myapp.py)</h2>
    
    <h3>Тестирование HTTP обработчика с mock объектами:</h3>
<pre><code>@patch('myapp.env.get_template')
def test_error_rendering(self, mock_get_template):
    """Тест рендеринга страницы ошибки."""
    mock_template = MagicMock()
    mock_template.render.return_value = "<html>Error</html>"
    mock_get_template.return_value = mock_template

    with patch.object(self.handler, 'send_response') as mock_send_response:
        self.handler._render_error("Test error", "/back")
        mock_send_response.assert_called_once_with(200)
        mock_get_template.assert_called_once_with("error.html")</code></pre>
    
    <h3>Тестирование методов перенаправления:</h3>
<pre><code>def test_redirect_method(self):
    """Тест метода перенаправления."""
    with patch.object(self.handler, 'send_response') as mock_send_response:
        self.handler._redirect('/test/path')
        mock_send_response.assert_called_once_with(302)</code></pre>
    
    <h2>7) Выводы</h2>
    <div class="success">
        <p>Модели (models/) инкапсулируют бизнес-логику и данные, Реализованы все CRUD операции через класс CurrencyRatesCRUD, реализован собственный HTTP сервер на базе BaseHTTPRequestHandler</p>
        <p>Обработаны основные маршруты: /, /currencies, /users, /user, /author</p>
        <p>Поддержка GET и POST запросов с парсингом параметров, Использован шаблонизатор Jinja2 для динамической генерации HTML, разработаны модульные тесты для всех моделей</p>
        <p>Созданы интеграционные тесты с использованием unittest.mock</p>
    </div>
</div>
</body>
</html>
